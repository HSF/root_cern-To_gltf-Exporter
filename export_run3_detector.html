<html>

<head>
    <meta charset=utf-8>
    <title>Test display</title>
    <script src="three.js/build/three.js"></script>
    <script src="three.js/examples/js/exporters/GLTFExporter.js"> </script>
    <script src="https://root.cern/js/latest/scripts/JSRoot.core.js"> </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

</head>

<body>
  <script>

    function match(name, paths) {
        for (const path of paths) {
            if (name.startsWith(path)) {
                return true;
            }
        }
        return false;
    }

    function filterArrayInPlace(a, condition, thisArg) {
        let j = 0;
        a.forEach((e, i) => { 
            if (condition.call(thisArg, e, i, a)) {
                if (i!==j) a[j] = e; 
                j++;
            }
        });
        a.length = j;
        return a;
    }

    var hide_children = [
        
        // VP
        /*"_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule01WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule03WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule05WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule07WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule09WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule11WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule13WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule15WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule17WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule19WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule21WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule23WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule25WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule27WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule29WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule31WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule33WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule35WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule37WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule39WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule41WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule43WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule45WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule47WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule49WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule51WithSupport_",

        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule01WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule03WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule05WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule07WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule09WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule11WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule13WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule15WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule17WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule19WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule21WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule23WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule25WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule27WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule29WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule31WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule33WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule35WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule37WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule39WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule41WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule43WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule45WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule47WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule49WithSupport_",
        "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule51WithSupport_",*/

        // Drop Muon Chambers
        "_dd_Geometry_DownstreamRegion_Muon_M2",
        "_dd_Geometry_DownstreamRegion_Muon_M3",
        "_dd_Geometry_DownstreamRegion_Muon_M4",
        "_dd_Geometry_DownstreamRegion_Muon_M5",
    
        // FT drop modules and frames
        "_dd_Geometry_AfterMagnetRegion_T_FT_Modules",
        "_dd_Geometry_AfterMagnetRegion_T_FT_CFrames",

    ];

    // for each level of hierarchy in the phoenix menu, tell which parts of the geometry to
    // use and whether they are initially visible or not.
    var subparts = {
        // Beam pipe
        "BeamPipe > UTPipe" : [["_dd_Geometry_BeforeMagnetRegion_UT_lvUT_pvUTBoxPlug",
                                "_dd_Geometry_BeforeMagnetRegion_UT_lvUT_pvUTJacket",
                                "_dd_Geometry_BeforeMagnetRegion_UT_lvUT_pvUX85",
                                "_dd_Geometry_BeforeMagnetRegion_UT_lvUT_pvUTPipe"], true],
        "BeamPipe > VPPipe" : [["_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvDown",
                                "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvUpStreamPipe",
                                "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvUpStreamWake"], true],
        "BeamPipe > Rich1Pipe" : [["_dd_Geometry_BeforeMagnetRegion_Rich1_lvRich1Master_pvUX85",
                                   "_dd_Geometry_BeforeMagnetRegion_Rich1_lvRich1SubMaster_pvUX85"], true],
        "BeamPipe > Rest" : [["_dd_Structure_LHCb_MagnetRegion_Pipe",
                              "_dd_Structure_LHCb_AfterMagnetRegion_T_PipeInT_",
                              "_dd_Structure_LHCb_AfterMagnetRegion_Pipe",
                              "_dd_Structure_LHCb_DownstreamRegion_Pipe"], true],
        // VP
        "VP > Struct" : [["_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvLeftDetSup",
                          "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvRightDetSup"], true],
        "VP > RFFoil" : [["_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvLeftRFFoil",
                          "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvrightRFFoil"], true],
        "VP > Modules" : [["_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPLeft_pvModule",
                           "_dd_Geometry_BeforeMagnetRegion_VP_lvVP_pvVPright_pvModule"], true],
        // UT
        "UT" : [["_dd_Geometry_BeforeMagnetRegion_UT_lvUT_pvUTFrame",
                 "_dd_Geometry_BeforeMagnetRegion_UT_lvUT_pvUTBox0x",
                 "_dd_Geometry_BeforeMagnetRegion_UT_lvUT_pvUTa"], true],
        // Rich1
        "Rich1 > Support" : [["_dd_Geometry_BeforeMagnetRegion_Rich1_lvRich1Master_pvRich1Mgs",
                              "_dd_Geometry_BeforeMagnetRegion_Rich1_lvRich1SubMaster_pvRich1Mgs"], false],
        "Rich1 > Mirrors" : [["_dd_Geometry_BeforeMagnetRegion_Rich1_lvRich1SubMaster_pvRich1Mag",
                              "_dd_Geometry_BeforeMagnetRegion_Rich1_lvRich1SubMaster_pvRich1Mirror"], true],
        "Rich1 > Exit" : [["_dd_Geometry_BeforeMagnetRegion_Rich1_lvRich1SubMaster_pvRich1Exit"], true],
        
        // Magnet
        "Magnet > Support" : [["_dd_Structure_LHCb_MagnetRegion_Magnet_Left_Vertical_Part",
                               "_dd_Structure_LHCb_MagnetRegion_Magnet_Right_Vertical_Part",
                               "_dd_Structure_LHCb_MagnetRegion_Magnet_Upper_Horizontal_Part",
                               "_dd_Structure_LHCb_MagnetRegion_Magnet_Lower_Horizontal_Part"], false],
        "Magnet > Coil" : [["_dd_Structure_LHCb_MagnetRegion_Magnet_UpperCoil",
                            "_dd_Structure_LHCb_MagnetRegion_Magnet_LowerCoil"], true],
        "Bcm" : [["_dd_Structure_LHCb_MagnetRegion_Bcm"], false],
        // FT
        "FT" : [["_dd_Structure_LHCb_AfterMagnetRegion_T_FT"], true],
        // Rich2
        "Rich2 > Support" : [["_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2AirBox",
                              "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2AirTrap"], true],
        "Rich2 > Frame" : [["_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2Tube",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2EntryWindowSkinBack",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2EntryWindowPMI",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2EntryWindowSkinFront",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2EntryWinTubeLock",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2ExitWindowSkinBack",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2ExitWindowPMI",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2ExitWindowSkinFront",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2ExitWinTubeLock",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2GasContTop",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2GasContBot",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2GasContSide0",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2GasContSide1",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2MagShFront0",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2MagShTop0",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2MagShBottom0",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2MagShSideBack0",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2MagShSideFront0",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2MagShFront1",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2MagShTop1",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2MagShBottom1",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2MagShSideBack1",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2MagShSideFront1",
                            "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRichSystem"], false],
        "Rich2 > Mirrors" : [["_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Gas_pvRich2Sec",
                              "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Gas_pvRich2SphMirrorCont",
                              "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Gas_pvRich2SecMirrorCont",
                              "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Gas_pvRich2SecMSupport",
                              "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2QuartzWindow_0",
                              "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2QuartzWindow_1",
                              "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2HPDN2Encl0",
                              "_dd_Geometry_AfterMagnetRegion_Rich2_lvRich2Master_pvRich2HPDN2Encl1"], true],
        // Neutron shielding
        "NeutronShielding" : [["_dd_Structure_LHCb_DownstreamRegion_NeutronShielding"], true],
        // Ecal
        "Ecal > Fiber" : [["_dd_Geometry_DownstreamRegion_Ecal_Installation_EcalLeft_Fiber",
                           "_dd_Geometry_DownstreamRegion_Ecal_Installation_EcalRight_Fiber"], false],
        "Ecal > InnSupport" : [["_dd_Geometry_DownstreamRegion_Ecal_Installation_EcalLeft_InnSupport",
                                "_dd_Geometry_DownstreamRegion_Ecal_Installation_EcalRight_InnSupport"], false],
        "Ecal > Inner" : [["_dd_Geometry_DownstreamRegion_Ecal_Installation_EcalLeft_EcalAInner",
                           "_dd_Geometry_DownstreamRegion_Ecal_Installation_EcalRight_EcalCInner"], false],
        "Ecal > Middle" : [["_dd_Geometry_DownstreamRegion_Ecal_Installation_EcalLeft_EcalAMiddle",
                            "_dd_Geometry_DownstreamRegion_Ecal_Installation_EcalRight_EcalCMiddle"], false],
        "Ecal > Outer" : [["_dd_Geometry_DownstreamRegion_Ecal_Installation_EcalLeft_EcalAOuter",
                           "_dd_Geometry_DownstreamRegion_Ecal_Installation_EcalRight_EcalCOuter"], false],
        // Hcal
        "Hcal > Inner" : [["_dd_Geometry_DownstreamRegion_Hcal_Installation_lvHcalInnerSectionRight_pvHcalInnHalfModule",
                           "_dd_Geometry_DownstreamRegion_Hcal_Installation_lvHcalInnerSectionLeft_pvHcalInnHalfModule"], false],
        "Hcal > InnerShielding" : [["_dd_Geometry_DownstreamRegion_Hcal_Installation_lvHcalInnerSectionRight_pvHcalInnerShielding",
                                    "_dd_Geometry_DownstreamRegion_Hcal_Installation_lvHcalInnerSectionLeft_pvHcalInnerShielding"], false],
        "Hcal > InnerReinforce" : [["_dd_Geometry_DownstreamRegion_Hcal_Installation_lvHcalInnerSectionRight_pvInnerReinforce",
                                    "_dd_Geometry_DownstreamRegion_Hcal_Installation_lvHcalInnerSectionLeft_pvInnerReinforce"], false],
        "Hcal > Outer" : [["_dd_Geometry_DownstreamRegion_Hcal_Installation_lvHcalOuterSectionLeft_pvHcalOutHalfModule",
                           "_dd_Geometry_DownstreamRegion_Hcal_Installation_lvHcalOuterSectionRight_pvHcalOutHalfModule"], false],
        "Hcal > OuterReinforce" : [["_dd_Geometry_DownstreamRegion_Hcal_Installation_lvHcalOuterSectionLeft_pvOuterReinforce",
                                    "_dd_Geometry_DownstreamRegion_Hcal_Installation_lvHcalOuterSectionRight_pvOuterReinforce"], false],
        // Muon
        "Muon > Back" : [["_dd_Geometry_DownstreamRegion_Muon_lvMuonBack_pvM2",
                          "_dd_Geometry_DownstreamRegion_Muon_lvMuonBack_pvM3",
                          "_dd_Geometry_DownstreamRegion_Muon_lvMuonBack_pvM4",
                          "_dd_Geometry_DownstreamRegion_Muon_lvMuonBack_pvM5"],true],
        "Muon > Filter" : [["_dd_Geometry_DownstreamRegion_Muon_lvMuonBack_pvMuFilter"], false],

    }
    
    function cleanup_geometry(node, level = 0, hidden_paths) {
        document.write(level); document.write(" " + node.fName + "<br>");
        if (node.fVolume.fNodes) {
            // drop hidden nodes, and everything after level 4
            filterArrayInPlace(node.fVolume.fNodes.arr, n=>(level < 4) && (!match(n.fName, hidden_paths)));
            // recurse to children
            for (const snode of node.fVolume.fNodes.arr) {
                cleanup_geometry(snode, level + 1, hidden_paths);
            }
        }
    }

    function deduplicate(gltf) {
        // deduplicate materials
        // scan them, build table of correspondance
        kept = []
        links = {}
        var materials = gltf["materials"];
        for (var index = 0; index < materials.length; index++) {
            var found = false;
            for (var kindex = 0; kindex < kept.length; kindex++) {
                if (JSON.stringify(kept[kindex]) == JSON.stringify(materials[index])) {
                    links[index] = kindex;
                    found = true;
                    break;
                }
            }
            if (!found) {
                links[index] = kept.langth;
                kept.push(materials[index]);
            }
        }
        // now rewrite the materials table and fix the meshes
        gltf["materials"] = kept;
        for (const mesh of gltf["meshes"]) {
            for(const primitive of mesh["primitives"]) {
                if ("material" in primitive) {
                    primitive["material"] = links[primitive["material"]];
                }
            }
        }
    }
    
    function convert_geometry(obj3d, name) {
        var exporter = new THREE.GLTFExporter;
        exporter.parse(obj3d, function(gltf) {
            deduplicate(gltf);
            var fileToSave = new Blob([JSON.stringify(gltf)], {
                type: 'application/json',
                name: "lhcb.gltf"
            });
            saveAs(fileToSave, "lhcb.gltf");
        })// FIXME use binary mode ? , function(){}, {binary:true})
    }

    function set_visible_recursively(node) {
        node.fVolume.fGeoAtt |= 4;
        if (node.fVolume.fNodes) {
            for (let j = 0; j < node.fVolume.fNodes.arr.length; j++) {
                snode = node.fVolume.fNodes.arr[j];
                set_visible_recursively(snode);
            }
        }
    }

    // returns whether anything was kept
    function keep_only_subpart(node, paths) {
        if (!node.fVolume.fNodes) return false;
        var anyfound = false;
        for (let j = 0; j < node.fVolume.fNodes.arr.length; j++) {
            snode = node.fVolume.fNodes.arr[j];
            tmpname = snode.fName;
            if (match(tmpname, paths)) {
                set_visible_recursively(snode);
                anyfound=true;
            } else {
                // only hide if no subpart is shown
                const subpartfound = keep_only_subpart(snode, paths);
                if (!subpartfound) {
                    snode.fVolume.fGeoAtt &= ~4;
                } else {
                    snode.fVolume.fGeoAtt |= 4; 
                    anyfound=true;
               }
            }
        }
        return anyfound;
    }
    
    function add_geometry(obj) {
        // drop nodes we do not want to see at all (usually too detailed parts)
        cleanup_geometry(obj.fNodes.arr[0], 0, hide_children);
        // dump to gltf, using one scene per subpart
        JSROOT.require('geom').then(geo => {
            var scenes = [];
            // for each geometry subpart, duplicate the geometry and keep only the subpart
            for (const [name, entry] of Object.entries(subparts)) {
                const paths = entry[0];
                const visible = entry[1];
                // extract subpart of ROOT geometry
                obj.fNodes.arr[0].fVolume.fGeoAtt |= 4;
                keep_only_subpart(obj.fNodes.arr[0], paths);
                // convert to gltf
                var scene = new THREE.Scene();
		scene.name = name;
                scene.children.push( geo.build(obj, {dflt_colors: true }) );
                scene.userData = {"visible" : visible};
                scenes.push(scene);
            }
            convert_geometry(scenes)
        });
    }

    function loadgeo() {
        var filename = "./LHCb_run3.root"
        JSROOT.openFile(filename)
            .then(file => file.readObject("Default;1"))
            .then(obj => add_geometry(obj));
    }

    loadgeo();

  </script>
</body>
