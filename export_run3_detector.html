<html>

<head>
    <meta charset=utf-8>
    <title>Test display</title>
    <script src="three.js/build/three.js"></script>
    <script src="GLTFExporter.js"> </script>
    <script src="https://root.cern/js/latest/scripts/JSRoot.core.js"> </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

</head>

<body>
  <script>
    var invisible = [
             "_dd_Structure_LHCb_MagnetRegion_Magnet_UpperCoil", "_dd_Structure_LHCb_MagnetRegion_Magnet_LowerCoil",
        //     "_dd_Structure_LHCb_MagnetRegion_Magnet_Left_Vertical_Part",
        //     "_dd_Structure_LHCb_MagnetRegion_Magnet_Right_Vertical_Part",
        //     "_dd_Structure_LHCb_MagnetRegion_Magnet_Upper_Horizontal_Part",
        //     "_dd_Structure_LHCb_MagnetRegion_Magnet_Lower_Horizontal_Part"
    ];

    function match(name, paths) {
        for (const path of paths) {
            if (name.startsWith(path)) {
                return true;
            }
        }
        return false;
    }
    
    var hide_children = [
        "_dd_Structure_LHCb_DownstreamRegion_Ecal",
        "_dd_Structure_LHCb_DownstreamRegion_Hcal",
        "_dd_Structure_LHCb_DownstreamRegion_Muon_pvMuonBack",
        "_dd_Structure_LHCb_BeforeMagnetRegion_Rich1",
        "_dd_Structure_LHCb_BeforeMagnetRegion_VP",
        "_dd_Structure_LHCb_BeforeMagnetRegion_UT",
        "_dd_Structure_LHCb_AfterMagnetRegion_Rich2",
        "_dd_Structure_LHCb_AfterMagnetRegion_T_FT"
        // pipe specific parts
        //     "_dd_Structure_LHCb_MagnetRegion_PipeSupportsInMagnet_", "_dd_Structure_LHCb_AfterMagnetRegion_T_PipeInT_", "_dd_Structure_LHCb_DownstreamRegion_PipeDownstream_", "_dd_Structure_LHCb_AfterMagnetRegion_Pipe", "_dd_Structure_LHCb_MagnetRegion_PipeInMagnet_",
        //     "_dd_Structure_LHCb_DownstreamRegion_PipeSupportsDownstream_", "_dd_Structure_LHCb_DownstreamRegion_PipeBakeoutDownstream_", "_dd_Structure_LHCb_MagnetRegion_BcmDown_", "_dd_Structure_LHCb_DownstreamRegion_NeutronShielding_"
    ];

    var subparts = {
        "pipe" : ["_dd_Structure_LHCb_MagnetRegion_Pipe", "_dd_Structure_LHCb_AfterMagnetRegion_T_PipeInT_"],
        "BeforeMagnetRegion > VP" : ["_dd_Structure_LHCb_BeforeMagnetRegion_VP"],
        "BeforeMagnetRegion > UT" : ["_dd_Structure_LHCb_BeforeMagnetRegion_UT"],
        "BeforeMagnetRegion > Rich1" : ["_dd_Structure_LHCb_BeforeMagnetRegion_Rich"],
        "MagnetRegion > Magnet" : ["_dd_Structure_LHCb_MagnetRegion_Magnet"],
        "MagnetRegion > Bcm" : ["_dd_Structure_LHCb_MagnetRegion_Bcm"],
        "AfterMagnetRegion > FT" : ["_dd_Structure_LHCb_AfterMagnetRegion_T_FT"],
        "AfterMagnetRegion > Rich2" : ["_dd_Structure_LHCb_AfterMagnetRegion_Rich"],
        "DownstreamRegion > neutronShielding" : ["_dd_Structure_LHCb_DownstreamRegion_NeutronShielding"],
        "DownstreamRegion > Ecal" : ["_dd_Structure_LHCb_DownstreamRegion_Ecal"],
        "DownstreamRegion > Hcal" : ["_dd_Structure_LHCb_DownstreamRegion_Hcal"],
        "DownstreamRegion > Muon" : ["_dd_Structure_LHCb_DownstreamRegion_Muon"],
    }

    function cleanup_geometry(node, level = 0, hidden_paths) {
        if (level <= 1) { document.write(level); document.write(" " + node.fName + "<br>"); }
        tmpname = node.fName;
        iterate_children = true;
        for (let i = 0; i < hidden_paths.length; i++) {
            item = hidden_paths[i];
            if (tmpname.startsWith(item)) {
                node.fVolume.fGeoAtt = 0;
                iterate_children = false;
            }
        }
        if (node.fVolume.fNodes && iterate_children) {
            for (let j = 0; j < node.fVolume.fNodes.arr.length; j++) {
                snode = node.fVolume.fNodes.arr[j];
                cleanup_geometry(snode, level + 1, hidden_paths);
            }
        }
    }
    
    function convert_geometry(obj3d, name) {
        GLTFExporter.parse(obj3d, function(gltf) {
            var fileToSave = new Blob([JSON.stringify(gltf)], {
                type: 'application/json',
                name: "lhcb.gltf"
            });
            saveAs(fileToSave, "lhcb.gltf");
        })
    }

    function handle_visibility(node) {
        node.fVolume.fGeoAtt |= 4;
        /*if (node.fVolume.fNodes) {
            for (let j = 0; j < node.fVolume.fNodes.arr.length; j++) {
                snode = node.fVolume.fNodes.arr[j];
                handle_visibility(snode);
            }
        }*/
    }
    
    function keep_only_subpart(obj, paths) {
        const node = obj.fNodes.arr[0];
        for (let j = 0; j < node.fVolume.fNodes.arr.length; j++) {
            snode = node.fVolume.fNodes.arr[j];
            tmpname = snode.fName;
            var found = match(tmpname, paths);
            if (found) {
                handle_visibility(snode);
            } else {
                snode.fVolume.fGeoAtt &= ~4;
            }
        }
    }
    
    function add_geometry(obj) {
        // options for building three.js model
        var opt = {
            numfaces: 5000000,
            numnodes: 50000,
            dflt_colors: true,
            vislevel: 4
        };
        // drop nodes we do not want to see at all (usually too detailed parts)
        cleanup_geometry(obj.fNodes.arr[0], 0, hide_children);
        JSROOT.require('geom').then(geo => {
            var scenes = [];
            // for each geometry subpart, duplicate the geometry and keep only the subpart
            for (const [name, paths] of Object.entries(subparts)) {
                // extract subpart of ROOT geometry
                keep_only_subpart(obj, paths);
                // convert to gltf
                var scene = new THREE.Scene();
		scene.name = name;
                scene.children.push( geo.build(obj, opt) );
                scenes.push(scene);
            }
            convert_geometry(scenes)
        });
    }

    function loadgeo() {
        var filename = "./LHCb_run3.root"
        JSROOT.openFile(filename)
            .then(file => file.readObject("Default;1"))
            .then(obj => add_geometry(obj));
    }

    loadgeo();

  </script>
</body>
