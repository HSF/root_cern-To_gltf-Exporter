<html>

<head>
    <meta charset=utf-8>
    <title>Test display</title>
    <style>
        body {
            margin: 0;
        }
        
        canvas {
            width: 100%;
            height: 100%
        }
    </style>
     <script src="jsroot/node_modules/three/build/three.js"></script>
    <script src="jsroot/node_modules/three/examples/js/controls/OrbitControls.js"></script>
    <script src="GLTFExporter.js"> </script>
    <script src="jsroot/scripts/JSRootCore.js?geom&onload=init" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

</head>

<body>

<script>
       
   
        var container, stats;
        var camera, scene, renderer, controls;

        var mouse = new THREE.Vector2(),
            INTERSECTED;
        var alllines = new THREE.Object3D();

        var rootgeom;
        var detector;


        function process_root_node(node, level = 0) {
            //console.log("processing:", node.fName, node)
            if (node.fVolumes) {
                for (let i = 0; i < node.fVolumes.arr.length; i++) {
                    subvol = node.fVolumes.arr[i];
                    if (!subvol.fName.startsWith("Velo")) {
                
                        // console.log("Disabling vis on ", subvol)
                        // JSROOT.GEO.SetBit(subvol, JSROOT.GEO.BITS.kVisThis, false);
                        // JSROOT.GEO.SetBit(subvol, JSROOT.GEO.BITS.kVisDaughters, false);
                        // console.log("Disabled vis on ", subvol)
                        subvol.fGeoAtt = 0;
                    }
                    //console.log("subvolume:", subvol.fName, subvol);
                    if (subvol.fNodes) {
                         for (let j = 0; j < subvol.fNodes.arr.length; j++) {
                             snode = subvol.fNodes.arr[j]
                    //         if (!snode.fName.startsWith("Velo")) {
                    //             //console.log("Disabling vis on ", snode)
                    //             // JSROOT.GEO.SetBit(snode.fVolume, JSROOT.GEO.BITS.kVisThis, false);
                    //             // JSROOT.GEO.SetBit(snode.fVolume, JSROOT.GEO.BITS.kVisDaughters, false);
                    //             // snode.fVolume.fTrans = 0.8;
                    //             snode.fVolume.fGeoAtt = 0;
                    //         }
                    //         //console.log("subnodes:", subvol.fNodes.arr[j].fName, subvol.fNodes.arr[j]);
                            process_root_node(subvol.fNodes.arr[j], level+ 1);
                         }
                    }
                }
            }
        }

        function add_geometry(obj) {

            // options for building three.js model
            var opt = {
                numfaces: 5000000,
                numnodes: 50000,
                dflt_colors: true,
                vislevel : 4
            };
            console.log(obj);
            rootgeom = obj;
            //process_root_node(obj);
            var obj3d = JSROOT.GEO.build(obj, opt, display_geometry);
        }

        // function process_node(node) {
        //     console.log("processing: ", node.name, "(", node.children.length, ")");
        //     for (let i = 0; i < node.children.length; i++) {
        //         process_node(node.children[i]);
        //     }
        // }

        function display_geometry(obj3d) {

            console.log("DISPLAYING", obj3d);
            if (!obj3d) return;

            detector = obj3d;
            scene.add(obj3d);
            var box3 = new THREE.Box3().setFromObject(obj3d);
            geom_size = box3.getSize().length();
            camera.far = geom_size * 5;
            camera.updateProjectionMatrix();
            postinit();
        }

        function loadgeo() {

            container = document.createElement('div');
            document.body.appendChild(container);

            // renderer
            renderer = new THREE.WebGLRenderer();
            renderer.setClearColor(0xFFFFFF);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            //renderer.setFaceCulling(false);

            renderer.sortObjects = false;
            container.appendChild(renderer.domElement);

            var info = document.createElement('div');
            info.style.position = 'absolute';
            info.style.top = '10px';
            info.style.width = '100%';
            info.style.textAlign = 'center';

            // camera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(-10000, 1000, 3000);
            //camera.up.set(0.0, 1.0, 0.0);

            // controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.target.set(0.0, 0.0, 8);

            // scene
            scene = new THREE.Scene();

            var filename = "lhcbfull.root"
            JSROOT.OpenFile(filename, function(file) {
                file.ReadObject("Geometry;1", add_geometry);

            });

        }

        function postinit() {


            // Particles
            // line 1
            var linegeometry1 = new THREE.Geometry();
            var line1 = new THREE.Line(linegeometry1, new THREE.LineBasicMaterial({
                color: 0x00033
            }));
            linegeometry1.vertices.push(new THREE.Vector3(0, 0, -1500));
            linegeometry1.vertices.push(new THREE.Vector3(1000, 1000, 15000));
            alllines.add(line1);

            // line 2
            var linegeometry2 = new THREE.Geometry();
            var line2 = new THREE.Line(linegeometry2, new THREE.LineBasicMaterial({
                color: 0x00033
            }));
            linegeometry2.vertices.push(new THREE.Vector3(0, 0, -1500));
            linegeometry2.vertices.push(new THREE.Vector3(-1000, 1000, 15000));
            alllines.add(line2);

            //line 3
            var linegeometry3 = new THREE.Geometry();
            var line3 = new THREE.Line(linegeometry3, new THREE.LineBasicMaterial({
                color: 0x00033
            }));
            linegeometry3.vertices.push(new THREE.Vector3(0, 0, -1500));
            linegeometry3.vertices.push(new THREE.Vector3(-1000, -1000, 15000));
            alllines.add(line3);

            scene.add(alllines);


            scene.add(new THREE.AmbientLight(0xff0000, 0.8));
            var light = new THREE.DirectionalLight(0x00ff00, 1);
            light.position.set(-100, 4000, -10000); //.normalize();
            scene.add(light);

            window.addEventListener('resize', onWindowResize, false);
            options = {};
             GLTFExporter.parse(detector, function ( gltf ) { 
                 console.log( gltf ); 
                
                 var fileToSave = new Blob([JSON.stringify(gltf)], {
                     type: 'application/json',
                     name: "lhcb.gltf"});

                 // Save the file
                 saveAs(fileToSave, "lhcb.gltf");
                 downloadJSON( gltf ); 
             }, options );
            animate();
        }


        function animate() {
            requestAnimationFrame(animate);
            render();
        }


        function render() {
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }


 </script>

<script>
  
  function init() {
            console.log("In init");
            loadgeo();
        }
</script>
</body>
